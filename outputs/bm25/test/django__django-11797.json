{
  "instance_id": "django__django-11797",
  "query": "Filtering on query result overrides GROUP BY of internal query\nDescription\n\t\nfrom django.contrib.auth import models\na = models.User.objects.filter(email__isnull=True).values('email').annotate(m=Max('id')).values('m')\nprint(a.query) # good\n# SELECT MAX(\"auth_user\".\"id\") AS \"m\" FROM \"auth_user\" WHERE \"auth_user\".\"email\" IS NULL GROUP BY \"auth_user\".\"email\"\nprint(a[:1].query) # good\n# SELECT MAX(\"auth_user\".\"id\") AS \"m\" FROM \"auth_user\" WHERE \"auth_user\".\"email\" IS NULL GROUP BY \"auth_user\".\"email\" LIMIT 1\nb = models.User.objects.filter(id=a[:1])\nprint(b.query) # GROUP BY U0.\"id\" should be GROUP BY U0.\"email\"\n# SELECT ... FROM \"auth_user\" WHERE \"auth_user\".\"id\" = (SELECT U0.\"id\" FROM \"auth_user\" U0 WHERE U0.\"email\" IS NULL GROUP BY U0.\"id\" LIMIT 1)\n",
  "ground_truth": {
    "files": [
      "django/db/models/lookups.py"
    ],
    "locations": [
      "django/db/models/lookups.py::Exact",
      "django/db/models/lookups.py::Exact.process_rhs"
    ]
  },
  "predictions": [
    "tests/raw_query/tests.py::RawQueryTests.test_annotations",
    "tests/aggregation_regress/tests.py::AggregationTests.test_annotate_with_extra",
    "tests/queries/tests.py::Queries1Tests.test_subquery_condition",
    "tests/auth_tests/test_management.py::CreatesuperuserManagementCommandTestCase.test_fields_with_fk_interactive",
    "django/core/mail/__init__.py::send_mass_mail",
    "tests/auth_tests/test_models.py::AbstractUserTestCase.test_email_user",
    "django/db/models/sql/compiler.py::SQLCompiler.get_group_by",
    "tests/expressions/tests.py::BasicExpressionsTests.test_aggregate_subquery_annotation",
    "django/core/mail/__init__.py::send_mail",
    "tests/extra_regress/tests.py::ExtraRegressTests.test_regression_8039"
  ],
  "metadata": {
    "repo": "django/django",
    "commit": "3346b78a8a872286a245d1e77ef4718fc5e6be1a",
    "total_functions_indexed": 22833,
    "retrieval_time_seconds": 1.014664649963379
  },
  "raw_output": "[{\"doc_id\": \"tests/raw_query/tests.py::RawQueryTests.test_annotations\", \"score\": 179.07489066101428}, {\"doc_id\": \"tests/aggregation_regress/tests.py::AggregationTests.test_annotate_with_extra\", \"score\": 177.69679210203256}, {\"doc_id\": \"tests/queries/tests.py::Queries1Tests.test_subquery_condition\", \"score\": 152.2132228125586}, {\"doc_id\": \"tests/auth_tests/test_management.py::CreatesuperuserManagementCommandTestCase.test_fields_with_fk_interactive\", \"score\": 150.4399001859492}, {\"doc_id\": \"django/core/mail/__init__.py::send_mass_mail\", \"score\": 148.56234637915202}, {\"doc_id\": \"tests/auth_tests/test_models.py::AbstractUserTestCase.test_email_user\", \"score\": 147.82956272281112}, {\"doc_id\": \"django/db/models/sql/compiler.py::SQLCompiler.get_group_by\", \"score\": 146.26001030948714}, {\"doc_id\": \"tests/expressions/tests.py::BasicExpressionsTests.test_aggregate_subquery_annotation\", \"score\": 142.92629839772087}, {\"doc_id\": \"django/core/mail/__init__.py::send_mail\", \"score\": 137.50800270523283}, {\"doc_id\": \"tests/extra_regress/tests.py::ExtraRegressTests.test_regression_8039\", \"score\": 134.7447607544409}]"
}