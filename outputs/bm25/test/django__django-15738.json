{
  "instance_id": "django__django-15738",
  "query": "Models migration with change field foreign to many and deleting unique together.\nDescription\n\t \n\t\t(last modified by Simon Charette)\n\t \nI have models like\nclass Authors(models.Model):\n\tproject_data_set = models.ForeignKey(\n\t\tProjectDataSet,\n\t\ton_delete=models.PROTECT\n\t)\n\tstate = models.IntegerField()\n\tstart_date = models.DateField()\n\tclass Meta:\n\t\t unique_together = (('project_data_set', 'state', 'start_date'),)\nand\nclass DataSet(models.Model):\n\tname = models.TextField(max_length=50)\nclass Project(models.Model):\n\tdata_sets = models.ManyToManyField(\n\t\tDataSet,\n\t\tthrough='ProjectDataSet',\n\t)\n\tname = models.TextField(max_length=50)\nclass ProjectDataSet(models.Model):\n\t\"\"\"\n\tCross table of data set and project\n\t\"\"\"\n\tdata_set = models.ForeignKey(DataSet, on_delete=models.PROTECT)\n\tproject = models.ForeignKey(Project, on_delete=models.PROTECT)\n\tclass Meta:\n\t\tunique_together = (('data_set', 'project'),)\nwhen i want to change field project_data_set in Authors model from foreign key field to many to many field I must delete a unique_together, cause it can't be on many to many field.\nThen my model should be like:\nclass Authors(models.Model):\n\tproject_data_set = models.ManyToManyField(\n\t\tProjectDataSet,\n\t)\n\tstate = models.IntegerField()\n\tstart_date = models.DateField()\nBut when I want to do a migrations.\npython3 manage.py makemigrations\npython3 manage.py migrate\nI have error:\nValueError: Found wrong number (0) of constraints for app_authors(project_data_set, state, start_date)\nThe database is on production, so I can't delete previous initial migrations, and this error isn't depending on database, cause I delete it and error is still the same.\nMy solve is to first delete unique_together, then do a makemigrations and then migrate. After that change the field from foreign key to many to many field, then do a makemigrations and then migrate.\nBut in this way I have 2 migrations instead of one.\nI added attachment with this project, download it and then do makemigrations and then migrate to see this error.\n",
  "ground_truth": {
    "files": [
      "django/db/migrations/autodetector.py"
    ],
    "locations": [
      "django/db/migrations/autodetector.py::MigrationAutodetector",
      "django/db/migrations/autodetector.py::MigrationAutodetector._generate_added_field"
    ]
  },
  "predictions": [
    "tests/invalid_models_tests/test_relative_fields.py::RelativeFieldTests.test_foreign_key_to_partially_unique_field",
    "tests/invalid_models_tests/test_relative_fields.py::RelativeFieldTests.test_foreign_key_to_non_unique_field_under_explicit_model",
    "tests/invalid_models_tests/test_relative_fields.py::RelativeFieldTests.test_relationship_model_with_foreign_key_to_wrong_model",
    "tests/invalid_models_tests/test_relative_fields.py::RelativeFieldTests.test_ambiguous_relationship_model_to",
    "tests/invalid_models_tests/test_relative_fields.py::RelativeFieldTests.test_foreign_key_to_non_unique_field",
    "tests/migrations/test_commands.py::MigrateTests.test_migrate_not_reflected_changes",
    "tests/invalid_models_tests/test_relative_fields.py::RelativeFieldTests.test_ambiguous_relationship_model_from",
    "tests/invalid_models_tests/test_relative_fields.py::RelativeFieldTests.test_relationship_model_missing_foreign_key",
    "tests/invalid_models_tests/test_relative_fields.py::RelativeFieldTests.test_foreign_object_to_partially_unique_field",
    "django/db/models/fields/related.py::RelatedField._check_clashes"
  ],
  "metadata": {
    "repo": "django/django",
    "commit": "6f73eb9d90cfec684529aab48d517e3d6449ba8c",
    "total_functions_indexed": 25994,
    "retrieval_time_seconds": 2.278242826461792
  },
  "raw_output": "[{\"doc_id\": \"tests/invalid_models_tests/test_relative_fields.py::RelativeFieldTests.test_foreign_key_to_partially_unique_field\", \"score\": 285.77567593153617}, {\"doc_id\": \"tests/invalid_models_tests/test_relative_fields.py::RelativeFieldTests.test_foreign_key_to_non_unique_field_under_explicit_model\", \"score\": 283.21164235759505}, {\"doc_id\": \"tests/invalid_models_tests/test_relative_fields.py::RelativeFieldTests.test_relationship_model_with_foreign_key_to_wrong_model\", \"score\": 282.51278621279897}, {\"doc_id\": \"tests/invalid_models_tests/test_relative_fields.py::RelativeFieldTests.test_ambiguous_relationship_model_to\", \"score\": 280.70672943626505}, {\"doc_id\": \"tests/invalid_models_tests/test_relative_fields.py::RelativeFieldTests.test_foreign_key_to_non_unique_field\", \"score\": 276.75966968123475}, {\"doc_id\": \"tests/migrations/test_commands.py::MigrateTests.test_migrate_not_reflected_changes\", \"score\": 276.72098085238304}, {\"doc_id\": \"tests/invalid_models_tests/test_relative_fields.py::RelativeFieldTests.test_ambiguous_relationship_model_from\", \"score\": 276.02058319376397}, {\"doc_id\": \"tests/invalid_models_tests/test_relative_fields.py::RelativeFieldTests.test_relationship_model_missing_foreign_key\", \"score\": 273.7684405308153}, {\"doc_id\": \"tests/invalid_models_tests/test_relative_fields.py::RelativeFieldTests.test_foreign_object_to_partially_unique_field\", \"score\": 270.14999731600017}, {\"doc_id\": \"django/db/models/fields/related.py::RelatedField._check_clashes\", \"score\": 270.0872300190066}]"
}