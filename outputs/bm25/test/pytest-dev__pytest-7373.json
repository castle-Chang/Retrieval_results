{
  "instance_id": "pytest-dev__pytest-7373",
  "query": "Incorrect caching of skipif/xfail string condition evaluation\nVersion: pytest 5.4.3, current master\r\n\r\npytest caches the evaluation of the string in e.g. `@pytest.mark.skipif(\"sys.platform == 'win32'\")`. The caching key is only the string itself (see `cached_eval` in `_pytest/mark/evaluate.py`). However, the evaluation also depends on the item's globals, so the caching can lead to incorrect results. Example:\r\n\r\n```py\r\n# test_module_1.py\r\nimport pytest\r\n\r\nskip = True\r\n\r\n@pytest.mark.skipif(\"skip\")\r\ndef test_should_skip():\r\n    assert False\r\n```\r\n\r\n```py\r\n# test_module_2.py\r\nimport pytest\r\n\r\nskip = False\r\n\r\n@pytest.mark.skipif(\"skip\")\r\ndef test_should_not_skip():\r\n    assert False\r\n```\r\n\r\nRunning `pytest test_module_1.py test_module_2.py`.\r\n\r\nExpected: `test_should_skip` is skipped, `test_should_not_skip` is not skipped.\r\n\r\nActual: both are skipped.\r\n\r\n---\r\n\r\nI think the most appropriate fix is to simply remove the caching, which I don't think is necessary really, and inline `cached_eval` into `MarkEvaluator._istrue`.\n",
  "ground_truth": {
    "files": [
      "src/_pytest/mark/evaluate.py"
    ],
    "locations": [
      "src/_pytest/mark/evaluate.py::cached_eval",
      "src/_pytest/mark/evaluate.py::MarkEvaluator",
      "src/_pytest/mark/evaluate.py::MarkEvaluator._istrue"
    ]
  },
  "predictions": [
    "src/_pytest/skipping.py::pytest_configure",
    "src/_pytest/outcomes.py::skip",
    "testing/test_skipping.py::test_imperativeskip_on_xfail_test",
    "testing/test_skipping.py::TestEvaluator.test_marked_skip_with_not_string",
    "testing/test_mark.py::TestFunctional.test_mark_from_parameters",
    "src/_pytest/mark/structures.py::MarkGenerator.__getattr__",
    "testing/test_skipping.py::TestEvaluator.test_marked_one_arg_twice",
    "src/_pytest/python.py::Module._importtestmodule",
    "testing/test_nose.py::test_setup_teardown_linking_issue265",
    "testing/test_terminal.py::TestTerminalFunctional.test_summary_s_alias"
  ],
  "metadata": {
    "repo": "pytest-dev/pytest",
    "commit": "7b77fc086aab8b3a8ebc890200371884555eea1e",
    "total_functions_indexed": 3929,
    "retrieval_time_seconds": 0.20980525016784668
  },
  "raw_output": "[{\"doc_id\": \"src/_pytest/skipping.py::pytest_configure\", \"score\": 140.6384393564124}, {\"doc_id\": \"src/_pytest/outcomes.py::skip\", \"score\": 111.87257582527721}, {\"doc_id\": \"testing/test_skipping.py::test_imperativeskip_on_xfail_test\", \"score\": 109.40948031834525}, {\"doc_id\": \"testing/test_skipping.py::TestEvaluator.test_marked_skip_with_not_string\", \"score\": 102.06206269522107}, {\"doc_id\": \"testing/test_mark.py::TestFunctional.test_mark_from_parameters\", \"score\": 101.76400457130221}, {\"doc_id\": \"src/_pytest/mark/structures.py::MarkGenerator.__getattr__\", \"score\": 101.41199056590769}, {\"doc_id\": \"testing/test_skipping.py::TestEvaluator.test_marked_one_arg_twice\", \"score\": 98.22486100868865}, {\"doc_id\": \"src/_pytest/python.py::Module._importtestmodule\", \"score\": 98.08323625915999}, {\"doc_id\": \"testing/test_nose.py::test_setup_teardown_linking_issue265\", \"score\": 97.80494484362846}, {\"doc_id\": \"testing/test_terminal.py::TestTerminalFunctional.test_summary_s_alias\", \"score\": 96.22813467933457}]"
}