{
  "instance_id": "django__django-12589",
  "query": "Django 3.0: \"GROUP BY\" clauses error with tricky field annotation\nDescription\n\t\nLet's pretend that we have next model structure with next model's relations:\nclass A(models.Model):\n\tbs = models.ManyToManyField('B',\n\t\t\t\t\t\t\t\trelated_name=\"a\",\n\t\t\t\t\t\t\t\tthrough=\"AB\")\nclass B(models.Model):\n\tpass\nclass AB(models.Model):\n\ta = models.ForeignKey(A, on_delete=models.CASCADE, related_name=\"ab_a\")\n\tb = models.ForeignKey(B, on_delete=models.CASCADE, related_name=\"ab_b\")\n\tstatus = models.IntegerField()\nclass C(models.Model):\n\ta = models.ForeignKey(\n\t\tA,\n\t\tnull=True,\n\t\tblank=True,\n\t\ton_delete=models.SET_NULL,\n\t\trelated_name=\"c\",\n\t\tverbose_name=_(\"a\")\n\t)\n\tstatus = models.IntegerField()\nLet's try to evaluate next query\nab_query = AB.objects.filter(a=OuterRef(\"pk\"), b=1)\nfilter_conditions = Q(pk=1) | Q(ab_a__b=1)\nquery = A.objects.\\\n\tfilter(filter_conditions).\\\n\tannotate(\n\t\tstatus=Subquery(ab_query.values(\"status\")),\n\t\tc_count=Count(\"c\"),\n)\nanswer = query.values(\"status\").annotate(total_count=Count(\"status\"))\nprint(answer.query)\nprint(answer)\nOn Django 3.0.4 we have an error\ndjango.db.utils.ProgrammingError: column reference \"status\" is ambiguous\nand query is next:\nSELECT (SELECT U0.\"status\" FROM \"test_app_ab\" U0 WHERE (U0.\"a_id\" = \"test_app_a\".\"id\" AND U0.\"b_id\" = 1)) AS \"status\", COUNT((SELECT U0.\"status\" FROM \"test_app_ab\" U0 WHERE (U0.\"a_id\" = \"test_app_a\".\"id\" AND U0.\"b_id\" = 1))) AS \"total_count\" FROM \"test_app_a\" LEFT OUTER JOIN \"test_app_ab\" ON (\"test_app_a\".\"id\" = \"test_app_ab\".\"a_id\") LEFT OUTER JOIN \"test_app_c\" ON (\"test_app_a\".\"id\" = \"test_app_c\".\"a_id\") WHERE (\"test_app_a\".\"id\" = 1 OR \"test_app_ab\".\"b_id\" = 1) GROUP BY \"status\"\nHowever, Django 2.2.11 processed this query properly with the next query:\nSELECT (SELECT U0.\"status\" FROM \"test_app_ab\" U0 WHERE (U0.\"a_id\" = (\"test_app_a\".\"id\") AND U0.\"b_id\" = 1)) AS \"status\", COUNT((SELECT U0.\"status\" FROM \"test_app_ab\" U0 WHERE (U0.\"a_id\" = (\"test_app_a\".\"id\") AND U0.\"b_id\" = 1))) AS \"total_count\" FROM \"test_app_a\" LEFT OUTER JOIN \"test_app_ab\" ON (\"test_app_a\".\"id\" = \"test_app_ab\".\"a_id\") LEFT OUTER JOIN \"test_app_c\" ON (\"test_app_a\".\"id\" = \"test_app_c\".\"a_id\") WHERE (\"test_app_a\".\"id\" = 1 OR \"test_app_ab\".\"b_id\" = 1) GROUP BY (SELECT U0.\"status\" FROM \"test_app_ab\" U0 WHERE (U0.\"a_id\" = (\"test_app_a\".\"id\") AND U0.\"b_id\" = 1))\nso, the difference in \"GROUP BY\" clauses\n(as DB provider uses \"django.db.backends.postgresql\", postgresql 11)\n",
  "ground_truth": {
    "files": [
      "django/db/models/sql/query.py"
    ],
    "locations": [
      "django/db/models/sql/query.py::Query",
      "django/db/models/sql/query.py::Query.set_group_by"
    ]
  },
  "predictions": [
    "tests/aggregation/tests.py::AggregateTestCase.test_aggregation_subquery_annotation_values",
    "django/db/models/sql/query.py::Query.set_group_by",
    "django/db/models/sql/query.py::Query.get_aggregation",
    "tests/aggregation/tests.py::AggregateTestCase.test_group_by_subquery_annotation",
    "tests/aggregation/tests.py::AggregateTestCase.test_ticket17424",
    "tests/aggregation/tests.py::AggregateTestCase.test_aggregation_subquery_annotation",
    "tests/invalid_models_tests/test_relative_fields.py::RelativeFieldTests.test_ambiguous_relationship_model_to",
    "tests/expressions/tests.py::BasicExpressionsTests.test_aggregate_subquery_annotation",
    "tests/aggregation_regress/tests.py::AggregationTests.test_fobj_group_by",
    "tests/aggregation/tests.py::AggregateTestCase.test_aggregation_subquery_annotation_multivalued"
  ],
  "metadata": {
    "repo": "django/django",
    "commit": "895f28f9cbed817c00ab68770433170d83132d90",
    "total_functions_indexed": 23366,
    "retrieval_time_seconds": 0.007462501525878906
  },
  "raw_output": "[{\"doc_id\": \"tests/aggregation/tests.py::AggregateTestCase.test_aggregation_subquery_annotation_values\", \"score\": 0.7590955495834351}, {\"doc_id\": \"django/db/models/sql/query.py::Query.set_group_by\", \"score\": 0.7582074403762817}, {\"doc_id\": \"django/db/models/sql/query.py::Query.get_aggregation\", \"score\": 0.7575404047966003}, {\"doc_id\": \"tests/aggregation/tests.py::AggregateTestCase.test_group_by_subquery_annotation\", \"score\": 0.7426607012748718}, {\"doc_id\": \"tests/aggregation/tests.py::AggregateTestCase.test_ticket17424\", \"score\": 0.7411313056945801}, {\"doc_id\": \"tests/aggregation/tests.py::AggregateTestCase.test_aggregation_subquery_annotation\", \"score\": 0.7399848699569702}, {\"doc_id\": \"tests/invalid_models_tests/test_relative_fields.py::RelativeFieldTests.test_ambiguous_relationship_model_to\", \"score\": 0.739032506942749}, {\"doc_id\": \"tests/expressions/tests.py::BasicExpressionsTests.test_aggregate_subquery_annotation\", \"score\": 0.7370753288269043}, {\"doc_id\": \"tests/aggregation_regress/tests.py::AggregationTests.test_fobj_group_by\", \"score\": 0.7368284463882446}, {\"doc_id\": \"tests/aggregation/tests.py::AggregateTestCase.test_aggregation_subquery_annotation_multivalued\", \"score\": 0.7364450097084045}]"
}