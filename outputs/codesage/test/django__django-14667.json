{
  "instance_id": "django__django-14667",
  "query": "QuerySet.defer() doesn't clear deferred field when chaining with only().\nDescription\n\t\nConsidering a simple Company model with four fields: id, name, trade_number and country. If we evaluate a queryset containing a .defer() following a .only(), the generated sql query selects unexpected fields. For example: \nCompany.objects.only(\"name\").defer(\"name\")\nloads all the fields with the following query:\nSELECT \"company\".\"id\", \"company\".\"name\", \"company\".\"trade_number\", \"company\".\"country\" FROM \"company\"\nand \nCompany.objects.only(\"name\").defer(\"name\").defer(\"country\")\nalso loads all the fields with the same query:\nSELECT \"company\".\"id\", \"company\".\"name\", \"company\".\"trade_number\", \"company\".\"country\" FROM \"company\"\nIn those two cases, i would expect the sql query to be:\nSELECT \"company\".\"id\" FROM \"company\"\nIn the following example, we get the expected behavior:\nCompany.objects.only(\"name\", \"country\").defer(\"name\")\nonly loads \"id\" and \"country\" fields with the following query:\nSELECT \"company\".\"id\", \"company\".\"country\" FROM \"company\"\n",
  "ground_truth": {
    "files": [
      "django/db/models/sql/query.py"
    ],
    "locations": [
      "django/db/models/sql/query.py::Query",
      "django/db/models/sql/query.py::Query.add_deferred_loading",
      "django/db/models/sql/query.py::Query.add_immediate_loading"
    ]
  },
  "predictions": [
    "tests/defer_regress/tests.py::DeferRegressionTest.test_only_and_defer_usage_on_proxy_models",
    "tests/defer/tests.py::DeferTests.test_only",
    "django/db/models/query.py::QuerySet.only",
    "tests/defer/tests.py::DeferTests.test_defer_only_chaining",
    "tests/defer/tests.py::DeferTests.test_get",
    "tests/defer/tests.py::DeferTests.test_defer_none_to_clear_deferred_set",
    "tests/defer/tests.py::DeferTests.test_defer_on_an_already_deferred_field",
    "tests/defer/tests.py::DeferTests.test_defer_with_select_related",
    "tests/defer_regress/tests.py::DeferRegressionTest.test_basic",
    "tests/defer/tests.py::DeferTests.test_defer_foreign_keys_are_deferred_and_not_traversed"
  ],
  "metadata": {
    "repo": "django/django",
    "commit": "6a970a8b4600eb91be25f38caed0a52269d6303d",
    "total_functions_indexed": 24858,
    "retrieval_time_seconds": 0.008815765380859375
  },
  "raw_output": "[{\"doc_id\": \"tests/defer_regress/tests.py::DeferRegressionTest.test_only_and_defer_usage_on_proxy_models\", \"score\": 0.6330890655517578}, {\"doc_id\": \"tests/defer/tests.py::DeferTests.test_only\", \"score\": 0.612136960029602}, {\"doc_id\": \"django/db/models/query.py::QuerySet.only\", \"score\": 0.6014410853385925}, {\"doc_id\": \"tests/defer/tests.py::DeferTests.test_defer_only_chaining\", \"score\": 0.5923787355422974}, {\"doc_id\": \"tests/defer/tests.py::DeferTests.test_get\", \"score\": 0.5691693425178528}, {\"doc_id\": \"tests/defer/tests.py::DeferTests.test_defer_none_to_clear_deferred_set\", \"score\": 0.5658208727836609}, {\"doc_id\": \"tests/defer/tests.py::DeferTests.test_defer_on_an_already_deferred_field\", \"score\": 0.5598275661468506}, {\"doc_id\": \"tests/defer/tests.py::DeferTests.test_defer_with_select_related\", \"score\": 0.5568538904190063}, {\"doc_id\": \"tests/defer_regress/tests.py::DeferRegressionTest.test_basic\", \"score\": 0.5551091432571411}, {\"doc_id\": \"tests/defer/tests.py::DeferTests.test_defer_foreign_keys_are_deferred_and_not_traversed\", \"score\": 0.5533992052078247}]"
}