{
  "instance_id": "django__django-15814",
  "query": "QuerySet.only() after select_related() crash on proxy models.\nDescription\n\t\nWhen I optimize a query using select_related() and only() methods from the proxy model I encounter an error:\nWindows 10; Python 3.10; Django 4.0.5\nTraceback (most recent call last):\n File \"D:\\study\\django_college\\manage.py\", line 22, in <module>\n\tmain()\n File \"D:\\study\\django_college\\manage.py\", line 18, in main\n\texecute_from_command_line(sys.argv)\n File \"D:\\Anaconda3\\envs\\django\\lib\\site-packages\\django\\core\\management\\__init__.py\", line 446, in execute_from_command_line\n\tutility.execute()\n File \"D:\\Anaconda3\\envs\\django\\lib\\site-packages\\django\\core\\management\\__init__.py\", line 440, in execute\n\tself.fetch_command(subcommand).run_from_argv(self.argv)\n File \"D:\\Anaconda3\\envs\\django\\lib\\site-packages\\django\\core\\management\\base.py\", line 414, in run_from_argv\n\tself.execute(*args, **cmd_options)\n File \"D:\\Anaconda3\\envs\\django\\lib\\site-packages\\django\\core\\management\\base.py\", line 460, in execute\n\toutput = self.handle(*args, **options)\n File \"D:\\study\\django_college\\project\\users\\management\\commands\\test_proxy.py\", line 9, in handle\n\tobjs = list(AnotherModel.objects.select_related(\"custom\").only(\"custom__name\").all())\n File \"D:\\Anaconda3\\envs\\django\\lib\\site-packages\\django\\db\\models\\query.py\", line 302, in __len__\n\tself._fetch_all()\n File \"D:\\Anaconda3\\envs\\django\\lib\\site-packages\\django\\db\\models\\query.py\", line 1507, in _fetch_all\n\tself._result_cache = list(self._iterable_class(self))\n File \"D:\\Anaconda3\\envs\\django\\lib\\site-packages\\django\\db\\models\\query.py\", line 71, in __iter__\n\trelated_populators = get_related_populators(klass_info, select, db)\n File \"D:\\Anaconda3\\envs\\django\\lib\\site-packages\\django\\db\\models\\query.py\", line 2268, in get_related_populators\n\trel_cls = RelatedPopulator(rel_klass_info, select, db)\n File \"D:\\Anaconda3\\envs\\django\\lib\\site-packages\\django\\db\\models\\query.py\", line 2243, in __init__\n\tself.pk_idx = self.init_list.index(self.model_cls._meta.pk.attname)\nValueError: 'id' is not in list\nModels:\nclass CustomModel(models.Model):\n\tname = models.CharField(max_length=16)\nclass ProxyCustomModel(CustomModel):\n\tclass Meta:\n\t\tproxy = True\nclass AnotherModel(models.Model):\n\tcustom = models.ForeignKey(\n\t\tProxyCustomModel,\n\t\ton_delete=models.SET_NULL,\n\t\tnull=True,\n\t\tblank=True,\n\t)\nCommand:\nclass Command(BaseCommand):\n\tdef handle(self, *args, **options):\n\t\tlist(AnotherModel.objects.select_related(\"custom\").only(\"custom__name\").all())\nAt django/db/models/sql/query.py in 745 line there is snippet:\nopts = cur_model._meta\nIf I replace it by \nopts = cur_model._meta.concrete_model._meta\nall works as expected.\n",
  "ground_truth": {
    "files": [
      "django/db/models/sql/query.py"
    ],
    "locations": [
      "django/db/models/sql/query.py::Query",
      "django/db/models/sql/query.py::Query.deferred_to_data"
    ]
  },
  "predictions": [
    "tests/proxy_models/tests.py::ProxyModelTests.test_select_related",
    "tests/generic_relations/tests.py::ProxyRelatedModelTest.test_query_proxy",
    "tests/select_related/tests.py::SelectRelatedTests.test_certain_fields",
    "tests/select_related/tests.py::SelectRelatedTests.test_more_certain_fields",
    "tests/defer/tests.py::TestDefer2.test_defer_proxy",
    "tests/select_related_onetoone/tests.py::ReverseSelectRelatedTestCase.test_inheritance_deferred2",
    "tests/proxy_models/tests.py::ProxyModelTests.test_proxy_bug",
    "tests/generic_relations/tests.py::ProxyRelatedModelTest.test_query",
    "tests/gis_tests/relatedapp/tests.py::RelatedGeoModelTest.test05_select_related_fk_to_subclass",
    "tests/model_inheritance/tests.py::ModelInheritanceDataTests.test_select_related_works_on_parent_model_fields"
  ],
  "metadata": {
    "repo": "django/django",
    "commit": "5eb6a2b33d70b9889e1cafa12594ad6f80773d3a",
    "total_functions_indexed": 26053,
    "retrieval_time_seconds": 0.09495830535888672
  },
  "raw_output": "[{\"doc_id\": \"tests/proxy_models/tests.py::ProxyModelTests.test_select_related\", \"score\": 0.6388331055641174}, {\"doc_id\": \"tests/generic_relations/tests.py::ProxyRelatedModelTest.test_query_proxy\", \"score\": 0.5548818111419678}, {\"doc_id\": \"tests/select_related/tests.py::SelectRelatedTests.test_certain_fields\", \"score\": 0.5506479144096375}, {\"doc_id\": \"tests/select_related/tests.py::SelectRelatedTests.test_more_certain_fields\", \"score\": 0.546456515789032}, {\"doc_id\": \"tests/defer/tests.py::TestDefer2.test_defer_proxy\", \"score\": 0.545547366142273}, {\"doc_id\": \"tests/select_related_onetoone/tests.py::ReverseSelectRelatedTestCase.test_inheritance_deferred2\", \"score\": 0.5321413278579712}, {\"doc_id\": \"tests/proxy_models/tests.py::ProxyModelTests.test_proxy_bug\", \"score\": 0.5299025774002075}, {\"doc_id\": \"tests/generic_relations/tests.py::ProxyRelatedModelTest.test_query\", \"score\": 0.5241501927375793}, {\"doc_id\": \"tests/gis_tests/relatedapp/tests.py::RelatedGeoModelTest.test05_select_related_fk_to_subclass\", \"score\": 0.5201565027236938}, {\"doc_id\": \"tests/model_inheritance/tests.py::ModelInheritanceDataTests.test_select_related_works_on_parent_model_fields\", \"score\": 0.5198332071304321}]"
}