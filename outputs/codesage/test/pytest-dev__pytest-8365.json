{
  "instance_id": "pytest-dev__pytest-8365",
  "query": "tmpdir creation fails when the username contains illegal characters for directory names\n`tmpdir`, `tmpdir_factory` and `tmp_path_factory` rely on `getpass.getuser()` for determining the `basetemp` directory. I found that the user name returned by `getpass.getuser()` may return characters that are not allowed for directory names. This may lead to errors while creating the temporary directory.\r\n\r\nThe situation in which I reproduced this issue was while being logged in through an ssh connection into my Windows 10 x64 Enterprise version (1909) using an OpenSSH_for_Windows_7.7p1 server. In this configuration the command `python -c \"import getpass; print(getpass.getuser())\"` returns my domain username e.g. `contoso\\john_doe` instead of `john_doe` as when logged in regularly using a local session.\r\n\r\nWhen trying to create a temp directory in pytest through e.g. `tmpdir_factory.mktemp('foobar')` this fails with the following error message:\r\n```\r\nself = WindowsPath('C:/Users/john_doe/AppData/Local/Temp/pytest-of-contoso/john_doe')\r\nmode = 511, parents = False, exist_ok = True\r\n\r\n    def mkdir(self, mode=0o777, parents=False, exist_ok=False):\r\n        \"\"\"\r\n        Create a new directory at this given path.\r\n        \"\"\"\r\n        if self._closed:\r\n            self._raise_closed()\r\n        try:\r\n>           self._accessor.mkdir(self, mode)\r\nE           FileNotFoundError: [WinError 3] The system cannot find the path specified: 'C:\\\\Users\\\\john_doe\\\\AppData\\\\Local\\\\Temp\\\\pytest-of-contoso\\\\john_doe'\r\n\r\nC:\\Python38\\lib\\pathlib.py:1266: FileNotFoundError\r\n```\r\n\r\nI could also reproduce this without the complicated ssh/windows setup with pytest 6.2.2 using the following commands from a `cmd`:\r\n```bat\r\necho def test_tmpdir(tmpdir):>test_tmp.py\r\necho   pass>>test_tmp.py\r\nset LOGNAME=contoso\\john_doe\r\npy.test test_tmp.py\r\n```\r\n\r\nThanks for having a look at this!\n",
  "ground_truth": {
    "files": [
      "src/_pytest/tmpdir.py"
    ],
    "locations": [
      "src/_pytest/tmpdir.py::TempPathFactory",
      "src/_pytest/tmpdir.py::TempPathFactory.getbasetemp"
    ]
  },
  "predictions": [
    "testing/test_tmpdir.py::attempt_symlink_to",
    "src/_pytest/tmpdir.py::TempdirFactory.mktemp",
    "src/_pytest/tmpdir.py::TempdirFactory.__init__",
    "src/_pytest/tmpdir.py::TempdirFactory.getbasetemp",
    "src/_pytest/pytester.py::Testdir.mkdir",
    "src/_pytest/tmpdir.py::TempPathFactory.__init__",
    "testing/test_tmpdir.py::test_tmpdir_fallback_uid_not_found",
    "src/_pytest/tmpdir.py::_mk_tmp",
    "src/_pytest/tmpdir.py::tmp_path_factory",
    "src/_pytest/tmpdir.py::TempPathFactory._ensure_relative_to_basetemp"
  ],
  "metadata": {
    "repo": "pytest-dev/pytest",
    "commit": "4964b468c83c06971eb743fbc57cc404f760c573",
    "total_functions_indexed": 4137,
    "retrieval_time_seconds": 0.18036150932312012
  },
  "raw_output": "[{\"doc_id\": \"testing/test_tmpdir.py::attempt_symlink_to\", \"score\": 0.34147340059280396}, {\"doc_id\": \"src/_pytest/tmpdir.py::TempdirFactory.mktemp\", \"score\": 0.3403512239456177}, {\"doc_id\": \"src/_pytest/tmpdir.py::TempdirFactory.__init__\", \"score\": 0.33824706077575684}, {\"doc_id\": \"src/_pytest/tmpdir.py::TempdirFactory.getbasetemp\", \"score\": 0.3370438814163208}, {\"doc_id\": \"src/_pytest/pytester.py::Testdir.mkdir\", \"score\": 0.33585238456726074}, {\"doc_id\": \"src/_pytest/tmpdir.py::TempPathFactory.__init__\", \"score\": 0.327472448348999}, {\"doc_id\": \"testing/test_tmpdir.py::test_tmpdir_fallback_uid_not_found\", \"score\": 0.318545937538147}, {\"doc_id\": \"src/_pytest/tmpdir.py::_mk_tmp\", \"score\": 0.31665322184562683}, {\"doc_id\": \"src/_pytest/tmpdir.py::tmp_path_factory\", \"score\": 0.3162823021411896}, {\"doc_id\": \"src/_pytest/tmpdir.py::TempPathFactory._ensure_relative_to_basetemp\", \"score\": 0.3142908811569214}]"
}