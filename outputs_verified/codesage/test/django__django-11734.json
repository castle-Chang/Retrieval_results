{
  "instance_id": "django__django-11734",
  "query": "OuterRef in exclude() or ~Q() uses wrong model.\nDescription\n\t\nThe following test (added to tests/queries/test_qs_combinators) fails when trying to exclude results using OuterRef()\ndef test_exists_exclude(self):\n\t# filter()\n\tqs = Number.objects.annotate(\n\t\tfoo=Exists(\n\t\t\tItem.objects.filter(tags__category_id=OuterRef('pk'))\n\t\t)\n\t).filter(foo=True)\n\tprint(qs) # works\n\t# exclude()\n\tqs = Number.objects.annotate(\n\t\tfoo =Exists(\n\t\t\tItem.objects.exclude(tags__category_id=OuterRef('pk'))\n\t\t)\n\t).filter(foo=True)\n\tprint(qs) # crashes\n\t# filter(~Q())\n\tqs = Number.objects.annotate(\n\t\tfoo =Exists(\n\t\t\tItem.objects.filter(~Q(tags__category_id=OuterRef('pk')))\n\t\t)\n\t).filter(foo=True)\n\tprint(qs) # crashes\nIt results in the following error\nValueError: This queryset contains a reference to an outer query and may only be used in a subquery\n",
  "ground_truth": {
    "files": [
      "django/db/models/fields/related_lookups.py",
      "django/db/models/sql/query.py",
      "django/db/models/fields/__init__.py"
    ],
    "locations": [
      "django/db/models/fields/__init__.py::AutoFieldMixin",
      "django/db/models/fields/__init__.py::AutoFieldMixin.get_db_prep_value",
      "django/db/models/fields/__init__.py::AutoFieldMixin.get_prep_value",
      "django/db/models/fields/__init__.py::AutoFieldMixin.contribute_to_class",
      "django/db/models/fields/related_lookups.py::RelatedLookupMixin",
      "django/db/models/fields/related_lookups.py::RelatedLookupMixin.get_prep_lookup",
      "django/db/models/sql/query.py::Query",
      "django/db/models/sql/query.py::Query.split_exclude"
    ]
  },
  "predictions": [
    "tests/expressions/tests.py::BasicExpressionsTests.test_outerref_mixed_case_table_name",
    "tests/queries/tests.py::Queries1Tests.test_tickets_5324_6704",
    "tests/expressions/tests.py::BasicExpressionsTests.test_outerref",
    "tests/expressions/tests.py::BasicExpressionsTests.test_outerref_with_operator",
    "tests/expressions/tests.py::BasicExpressionsTests.test_subquery_references_joined_table_twice",
    "django/db/models/expressions.py::ResolvedOuterRef.as_sql",
    "tests/queries/tests.py::Queries1Tests.test_nested_exclude",
    "tests/expressions/tests.py::BasicExpressionsTests.test_nested_subquery_outer_ref_2",
    "tests/expressions/tests.py::BasicExpressionsTests.test_nested_subquery_outer_ref_with_autofield",
    "tests/null_queries/tests.py::NullQueriesTests.test_reverse_relations"
  ],
  "metadata": {
    "repo": "django/django",
    "commit": "999891bd80b3d02dd916731a7a239e1036174885",
    "total_functions_indexed": 22797,
    "retrieval_time_seconds": 0.00845026969909668
  },
  "raw_output": "[{\"doc_id\": \"tests/expressions/tests.py::BasicExpressionsTests.test_outerref_mixed_case_table_name\", \"score\": 0.6405099034309387}, {\"doc_id\": \"tests/queries/tests.py::Queries1Tests.test_tickets_5324_6704\", \"score\": 0.623304545879364}, {\"doc_id\": \"tests/expressions/tests.py::BasicExpressionsTests.test_outerref\", \"score\": 0.6181634664535522}, {\"doc_id\": \"tests/expressions/tests.py::BasicExpressionsTests.test_outerref_with_operator\", \"score\": 0.6132898330688477}, {\"doc_id\": \"tests/expressions/tests.py::BasicExpressionsTests.test_subquery_references_joined_table_twice\", \"score\": 0.6084206700325012}, {\"doc_id\": \"django/db/models/expressions.py::ResolvedOuterRef.as_sql\", \"score\": 0.5924718379974365}, {\"doc_id\": \"tests/queries/tests.py::Queries1Tests.test_nested_exclude\", \"score\": 0.5892031192779541}, {\"doc_id\": \"tests/expressions/tests.py::BasicExpressionsTests.test_nested_subquery_outer_ref_2\", \"score\": 0.5872642397880554}, {\"doc_id\": \"tests/expressions/tests.py::BasicExpressionsTests.test_nested_subquery_outer_ref_with_autofield\", \"score\": 0.5732625722885132}, {\"doc_id\": \"tests/null_queries/tests.py::NullQueriesTests.test_reverse_relations\", \"score\": 0.5674052238464355}]"
}