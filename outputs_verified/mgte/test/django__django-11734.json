{
  "instance_id": "django__django-11734",
  "query": "OuterRef in exclude() or ~Q() uses wrong model.\nDescription\n\t\nThe following test (added to tests/queries/test_qs_combinators) fails when trying to exclude results using OuterRef()\ndef test_exists_exclude(self):\n\t# filter()\n\tqs = Number.objects.annotate(\n\t\tfoo=Exists(\n\t\t\tItem.objects.filter(tags__category_id=OuterRef('pk'))\n\t\t)\n\t).filter(foo=True)\n\tprint(qs) # works\n\t# exclude()\n\tqs = Number.objects.annotate(\n\t\tfoo =Exists(\n\t\t\tItem.objects.exclude(tags__category_id=OuterRef('pk'))\n\t\t)\n\t).filter(foo=True)\n\tprint(qs) # crashes\n\t# filter(~Q())\n\tqs = Number.objects.annotate(\n\t\tfoo =Exists(\n\t\t\tItem.objects.filter(~Q(tags__category_id=OuterRef('pk')))\n\t\t)\n\t).filter(foo=True)\n\tprint(qs) # crashes\nIt results in the following error\nValueError: This queryset contains a reference to an outer query and may only be used in a subquery\n",
  "ground_truth": {
    "files": [
      "django/db/models/fields/__init__.py",
      "django/db/models/sql/query.py",
      "django/db/models/fields/related_lookups.py"
    ],
    "locations": [
      "django/db/models/fields/__init__.py::AutoFieldMixin",
      "django/db/models/fields/__init__.py::AutoFieldMixin.get_db_prep_value",
      "django/db/models/fields/__init__.py::AutoFieldMixin.get_prep_value",
      "django/db/models/fields/__init__.py::AutoFieldMixin.contribute_to_class",
      "django/db/models/fields/related_lookups.py::RelatedLookupMixin",
      "django/db/models/fields/related_lookups.py::RelatedLookupMixin.get_prep_lookup",
      "django/db/models/sql/query.py::Query",
      "django/db/models/sql/query.py::Query.split_exclude"
    ]
  },
  "predictions": [
    "tests/queries/tests.py::EmptyStringsAsNullTest.test_direct_exclude",
    "tests/queries/tests.py::Queries1Tests.test_nested_exclude",
    "tests/expressions/tests.py::BasicExpressionsTests.test_outerref",
    "tests/queries/tests.py::Queries1Tests.test_exclude_in",
    "tests/queries/tests.py::EmptyStringsAsNullTest.test_joined_exclude",
    "tests/queries/tests.py::Queries1Tests.test_ticket7076",
    "tests/queries/tests.py::Queries6Tests.test_tickets_8921_9188",
    "tests/queries/tests.py::NullInExcludeTest.test_null_in_exclude_qs",
    "tests/queries/tests.py::Queries1Tests.test_exclude",
    "tests/queries/tests.py::Queries1Tests.test_ticket7096"
  ],
  "metadata": {
    "repo": "django/django",
    "commit": "999891bd80b3d02dd916731a7a239e1036174885",
    "total_functions_indexed": 22797,
    "retrieval_time_seconds": 0.019152164459228516
  },
  "raw_output": "[{\"doc_id\": \"tests/queries/tests.py::EmptyStringsAsNullTest.test_direct_exclude\", \"score\": 0.8004343509674072}, {\"doc_id\": \"tests/queries/tests.py::Queries1Tests.test_nested_exclude\", \"score\": 0.7967936396598816}, {\"doc_id\": \"tests/expressions/tests.py::BasicExpressionsTests.test_outerref\", \"score\": 0.7958664894104004}, {\"doc_id\": \"tests/queries/tests.py::Queries1Tests.test_exclude_in\", \"score\": 0.7810505628585815}, {\"doc_id\": \"tests/queries/tests.py::EmptyStringsAsNullTest.test_joined_exclude\", \"score\": 0.7777823805809021}, {\"doc_id\": \"tests/queries/tests.py::Queries1Tests.test_ticket7076\", \"score\": 0.775901198387146}, {\"doc_id\": \"tests/queries/tests.py::Queries6Tests.test_tickets_8921_9188\", \"score\": 0.772068440914154}, {\"doc_id\": \"tests/queries/tests.py::NullInExcludeTest.test_null_in_exclude_qs\", \"score\": 0.7690334320068359}, {\"doc_id\": \"tests/queries/tests.py::Queries1Tests.test_exclude\", \"score\": 0.7655309438705444}, {\"doc_id\": \"tests/queries/tests.py::Queries1Tests.test_ticket7096\", \"score\": 0.7639769911766052}]"
}