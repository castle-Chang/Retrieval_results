{
  "instance_id": "django__django-11734",
  "query": "OuterRef in exclude() or ~Q() uses wrong model.\nDescription\n\t\nThe following test (added to tests/queries/test_qs_combinators) fails when trying to exclude results using OuterRef()\ndef test_exists_exclude(self):\n\t# filter()\n\tqs = Number.objects.annotate(\n\t\tfoo=Exists(\n\t\t\tItem.objects.filter(tags__category_id=OuterRef('pk'))\n\t\t)\n\t).filter(foo=True)\n\tprint(qs) # works\n\t# exclude()\n\tqs = Number.objects.annotate(\n\t\tfoo =Exists(\n\t\t\tItem.objects.exclude(tags__category_id=OuterRef('pk'))\n\t\t)\n\t).filter(foo=True)\n\tprint(qs) # crashes\n\t# filter(~Q())\n\tqs = Number.objects.annotate(\n\t\tfoo =Exists(\n\t\t\tItem.objects.filter(~Q(tags__category_id=OuterRef('pk')))\n\t\t)\n\t).filter(foo=True)\n\tprint(qs) # crashes\nIt results in the following error\nValueError: This queryset contains a reference to an outer query and may only be used in a subquery\n",
  "ground_truth": {
    "files": [
      "django/db/models/fields/__init__.py",
      "django/db/models/sql/query.py",
      "django/db/models/fields/related_lookups.py"
    ],
    "locations": [
      "django/db/models/fields/__init__.py::AutoFieldMixin",
      "django/db/models/fields/__init__.py::AutoFieldMixin.get_db_prep_value",
      "django/db/models/fields/__init__.py::AutoFieldMixin.get_prep_value",
      "django/db/models/fields/__init__.py::AutoFieldMixin.contribute_to_class",
      "django/db/models/fields/related_lookups.py::RelatedLookupMixin",
      "django/db/models/fields/related_lookups.py::RelatedLookupMixin.get_prep_lookup",
      "django/db/models/sql/query.py::Query",
      "django/db/models/sql/query.py::Query.split_exclude"
    ]
  },
  "predictions": [
    "tests/expressions/tests.py::BasicExpressionsTests.test_subquery",
    "tests/expressions/tests.py::BasicExpressionsTests.test_outerref",
    "tests/lookup/tests.py::LookupTests.test_exact_exists",
    "tests/gis_tests/distapp/tests.py::DistanceTest.test_dwithin_subquery",
    "tests/expressions/tests.py::BasicExpressionsTests.test_case_in_filter_if_boolean_output_field",
    "tests/lookup/tests.py::LookupTests.test_nested_outerref_lhs",
    "tests/queries/tests.py::DisjunctionPromotionTests.test_disjunction_promotion7",
    "tests/queries/tests.py::DisjunctionPromotionTests.test_disjunction_promotion_fexpression",
    "tests/queries/tests.py::DisjunctionPromotionTests.test_disjunction_promotion1",
    "tests/queries/tests.py::DisjunctionPromotionTests.test_disjunction_promotion6"
  ],
  "metadata": {
    "repo": "django/django",
    "commit": "999891bd80b3d02dd916731a7a239e1036174885",
    "total_functions_indexed": 22797,
    "retrieval_time_seconds": 1.3745789527893066
  },
  "raw_output": "[{\"doc_id\": \"tests/expressions/tests.py::BasicExpressionsTests.test_subquery\", \"score\": 197.43117384902078}, {\"doc_id\": \"tests/expressions/tests.py::BasicExpressionsTests.test_outerref\", \"score\": 185.53640466551568}, {\"doc_id\": \"tests/lookup/tests.py::LookupTests.test_exact_exists\", \"score\": 183.67661715134108}, {\"doc_id\": \"tests/gis_tests/distapp/tests.py::DistanceTest.test_dwithin_subquery\", \"score\": 181.03335296050008}, {\"doc_id\": \"tests/expressions/tests.py::BasicExpressionsTests.test_case_in_filter_if_boolean_output_field\", \"score\": 175.10456747800995}, {\"doc_id\": \"tests/lookup/tests.py::LookupTests.test_nested_outerref_lhs\", \"score\": 174.10564223743827}, {\"doc_id\": \"tests/queries/tests.py::DisjunctionPromotionTests.test_disjunction_promotion7\", \"score\": 169.1020509956096}, {\"doc_id\": \"tests/queries/tests.py::DisjunctionPromotionTests.test_disjunction_promotion_fexpression\", \"score\": 168.13261068158246}, {\"doc_id\": \"tests/queries/tests.py::DisjunctionPromotionTests.test_disjunction_promotion1\", \"score\": 167.51960238939338}, {\"doc_id\": \"tests/queries/tests.py::DisjunctionPromotionTests.test_disjunction_promotion6\", \"score\": 166.42653360896082}]"
}