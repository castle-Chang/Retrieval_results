{
  "instance_id": "django__django-15814",
  "query": "QuerySet.only() after select_related() crash on proxy models.\nDescription\n\t\nWhen I optimize a query using select_related() and only() methods from the proxy model I encounter an error:\nWindows 10; Python 3.10; Django 4.0.5\nTraceback (most recent call last):\n File \"D:\\study\\django_college\\manage.py\", line 22, in <module>\n\tmain()\n File \"D:\\study\\django_college\\manage.py\", line 18, in main\n\texecute_from_command_line(sys.argv)\n File \"D:\\Anaconda3\\envs\\django\\lib\\site-packages\\django\\core\\management\\__init__.py\", line 446, in execute_from_command_line\n\tutility.execute()\n File \"D:\\Anaconda3\\envs\\django\\lib\\site-packages\\django\\core\\management\\__init__.py\", line 440, in execute\n\tself.fetch_command(subcommand).run_from_argv(self.argv)\n File \"D:\\Anaconda3\\envs\\django\\lib\\site-packages\\django\\core\\management\\base.py\", line 414, in run_from_argv\n\tself.execute(*args, **cmd_options)\n File \"D:\\Anaconda3\\envs\\django\\lib\\site-packages\\django\\core\\management\\base.py\", line 460, in execute\n\toutput = self.handle(*args, **options)\n File \"D:\\study\\django_college\\project\\users\\management\\commands\\test_proxy.py\", line 9, in handle\n\tobjs = list(AnotherModel.objects.select_related(\"custom\").only(\"custom__name\").all())\n File \"D:\\Anaconda3\\envs\\django\\lib\\site-packages\\django\\db\\models\\query.py\", line 302, in __len__\n\tself._fetch_all()\n File \"D:\\Anaconda3\\envs\\django\\lib\\site-packages\\django\\db\\models\\query.py\", line 1507, in _fetch_all\n\tself._result_cache = list(self._iterable_class(self))\n File \"D:\\Anaconda3\\envs\\django\\lib\\site-packages\\django\\db\\models\\query.py\", line 71, in __iter__\n\trelated_populators = get_related_populators(klass_info, select, db)\n File \"D:\\Anaconda3\\envs\\django\\lib\\site-packages\\django\\db\\models\\query.py\", line 2268, in get_related_populators\n\trel_cls = RelatedPopulator(rel_klass_info, select, db)\n File \"D:\\Anaconda3\\envs\\django\\lib\\site-packages\\django\\db\\models\\query.py\", line 2243, in __init__\n\tself.pk_idx = self.init_list.index(self.model_cls._meta.pk.attname)\nValueError: 'id' is not in list\nModels:\nclass CustomModel(models.Model):\n\tname = models.CharField(max_length=16)\nclass ProxyCustomModel(CustomModel):\n\tclass Meta:\n\t\tproxy = True\nclass AnotherModel(models.Model):\n\tcustom = models.ForeignKey(\n\t\tProxyCustomModel,\n\t\ton_delete=models.SET_NULL,\n\t\tnull=True,\n\t\tblank=True,\n\t)\nCommand:\nclass Command(BaseCommand):\n\tdef handle(self, *args, **options):\n\t\tlist(AnotherModel.objects.select_related(\"custom\").only(\"custom__name\").all())\nAt django/db/models/sql/query.py in 745 line there is snippet:\nopts = cur_model._meta\nIf I replace it by \nopts = cur_model._meta.concrete_model._meta\nall works as expected.\n",
  "ground_truth": {
    "files": [
      "django/db/models/sql/query.py"
    ],
    "locations": [
      "django/db/models/sql/query.py::Query",
      "django/db/models/sql/query.py::Query.deferred_to_data"
    ]
  },
  "predictions": [
    "django/db/models/sql/query.py::Query.add_select_related",
    "django/core/files/base.py::File.__iter__",
    "tests/utils_tests/test_autoreload.py::RestartWithReloaderTests.test_python_m_django",
    "django/template/defaultfilters.py::linenumbers",
    "django/core/management/commands/loaddata.py::Command.reset_sequences",
    "django/db/models/query.py::get_related_populators",
    "django/db/backends/postgresql/introspection.py::DatabaseIntrospection.get_table_description",
    "django/core/management/commands/inspectdb.py::Command.handle",
    "django/core/management/commands/test.py::Command.run_from_argv",
    "django/db/migrations/writer.py::MigrationWriter.as_string"
  ],
  "metadata": {
    "repo": "django/django",
    "commit": "5eb6a2b33d70b9889e1cafa12594ad6f80773d3a",
    "total_functions_indexed": 26053,
    "retrieval_time_seconds": 6.019344329833984
  },
  "raw_output": "[{\"doc_id\": \"django/db/models/sql/query.py::Query.add_select_related\", \"score\": 290.5379394384787}, {\"doc_id\": \"django/core/files/base.py::File.__iter__\", \"score\": 259.524854862854}, {\"doc_id\": \"tests/utils_tests/test_autoreload.py::RestartWithReloaderTests.test_python_m_django\", \"score\": 254.7971419223695}, {\"doc_id\": \"django/template/defaultfilters.py::linenumbers\", \"score\": 251.6456238568189}, {\"doc_id\": \"django/core/management/commands/loaddata.py::Command.reset_sequences\", \"score\": 251.1100705394279}, {\"doc_id\": \"django/db/models/query.py::get_related_populators\", \"score\": 236.90395998398722}, {\"doc_id\": \"django/db/backends/postgresql/introspection.py::DatabaseIntrospection.get_table_description\", \"score\": 234.44224804734753}, {\"doc_id\": \"django/core/management/commands/inspectdb.py::Command.handle\", \"score\": 233.88524255561327}, {\"doc_id\": \"django/core/management/commands/test.py::Command.run_from_argv\", \"score\": 231.24478216758786}, {\"doc_id\": \"django/db/migrations/writer.py::MigrationWriter.as_string\", \"score\": 230.2732931302624}]"
}