{
  "instance_id": "django__django-14170",
  "query": "Query optimization in YearLookup breaks filtering by \"__iso_year\"\nDescription\n\t \n\t\t(last modified by Florian Demmer)\n\t \nThe optimization to use BETWEEN instead of the EXTRACT operation in ​YearLookup is also registered for the ​\"__iso_year\" lookup, which breaks the functionality provided by ​ExtractIsoYear when used via the lookup.\nThis has unfortunately been broken ever since ExtractIsoYear was introduced in ​Django 2.2 via #28649 and wasn't easy to track down since ExtractIsoYear when used by itself eg. in an annotation works perfectly fine. Just when using the lookup in a filter, the optimization is used (even when explicitly using an annotation):\n# annotation works\n>>> qs = DTModel.objects.annotate(extracted=ExtractIsoYear('start_date')).only('id')\n>>> print(qs.query)\nSELECT \"db_functions_dtmodel\".\"id\", EXTRACT('isoyear' FROM \"db_functions_dtmodel\".\"start_date\") AS \"extracted\" FROM \"db_functions_dtmodel\"\n# explicit annotation used in filter does not use \"extracted\" and adds BETWEEN\n>>> print(qs.filter(extracted=2020).query)\nSELECT \"db_functions_dtmodel\".\"id\", EXTRACT('isoyear' FROM \"db_functions_dtmodel\".\"start_date\") AS \"extracted\" FROM \"db_functions_dtmodel\" WHERE \"db_functions_dtmodel\".\"start_date\" BETWEEN 2020-01-01 AND 2020-12-31\n# implicit lookup uses BETWEEN\n>>> print(DTModel.objects.filter(start_date__iso_year=2020).only('id').query)\nSELECT \"db_functions_dtmodel\".\"id\" FROM \"db_functions_dtmodel\" WHERE \"db_functions_dtmodel\".\"start_date\" BETWEEN 2020-01-01 AND 2020-12-31\nThis results in the wrong data being returned by filters using iso_year.\nThis PR fixes the behaviour, reverts the invalid changes to the tests and extends one test to catch this problem: ​https://github.com/django/django/pull/14157\n",
  "ground_truth": {
    "files": [
      "django/db/models/lookups.py",
      "django/db/backends/base/operations.py"
    ],
    "locations": [
      "django/db/backends/base/operations.py::BaseDatabaseOperations",
      "django/db/backends/base/operations.py::BaseDatabaseOperations.adapt_ipaddressfield_value",
      "django/db/backends/base/operations.py::BaseDatabaseOperations.year_lookup_bounds_for_date_field",
      "django/db/backends/base/operations.py::BaseDatabaseOperations.year_lookup_bounds_for_datetime_field",
      "django/db/models/lookups.py::YearLookup",
      "django/db/models/lookups.py::YearLookup.year_lookup_bounds",
      "django/db/models/lookups.py::YearLookup.as_sql"
    ]
  },
  "predictions": [
    "tests/db_functions/datetime/test_extract_trunc.py::DateFunctionTests.test_extract_year_exact_lookup",
    "tests/db_functions/datetime/test_extract_trunc.py::DateFunctionTests.test_extract_iso_year_func",
    "django/db/models/sql/query.py::Query.split_exclude",
    "tests/aggregation_regress/tests.py::AggregationTests.test_annotate_with_extra",
    "tests/db_functions/datetime/test_extract_trunc.py::DateFunctionTests.test_extract_func",
    "tests/db_functions/datetime/test_extract_trunc.py::DateFunctionTests.test_extract_none",
    "django/db/backends/base/base.py::BaseDatabaseWrapper.validate_thread_sharing",
    "tests/aggregation_regress/tests.py::AggregationTests.test_filtering_by_annotation_name",
    "django/db/models/query.py::QuerySet._next_is_sticky",
    "django/db/models/sql/query.py::Query.build_lookup"
  ],
  "metadata": {
    "repo": "django/django",
    "commit": "6efc35b4fe3009666e56a60af0675d7d532bf4ff",
    "total_functions_indexed": 24435,
    "retrieval_time_seconds": 3.041970729827881
  },
  "raw_output": "[{\"doc_id\": \"tests/db_functions/datetime/test_extract_trunc.py::DateFunctionTests.test_extract_year_exact_lookup\", \"score\": 215.31085744207326}, {\"doc_id\": \"tests/db_functions/datetime/test_extract_trunc.py::DateFunctionTests.test_extract_iso_year_func\", \"score\": 173.26461709139423}, {\"doc_id\": \"django/db/models/sql/query.py::Query.split_exclude\", \"score\": 165.9635166014131}, {\"doc_id\": \"tests/aggregation_regress/tests.py::AggregationTests.test_annotate_with_extra\", \"score\": 165.48163874181859}, {\"doc_id\": \"tests/db_functions/datetime/test_extract_trunc.py::DateFunctionTests.test_extract_func\", \"score\": 165.1849753654401}, {\"doc_id\": \"tests/db_functions/datetime/test_extract_trunc.py::DateFunctionTests.test_extract_none\", \"score\": 165.00140998892005}, {\"doc_id\": \"django/db/backends/base/base.py::BaseDatabaseWrapper.validate_thread_sharing\", \"score\": 161.1897014625502}, {\"doc_id\": \"tests/aggregation_regress/tests.py::AggregationTests.test_filtering_by_annotation_name\", \"score\": 161.10659501422478}, {\"doc_id\": \"django/db/models/query.py::QuerySet._next_is_sticky\", \"score\": 160.9133294451224}, {\"doc_id\": \"django/db/models/sql/query.py::Query.build_lookup\", \"score\": 159.53721483117016}]"
}