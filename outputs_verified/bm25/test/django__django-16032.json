{
  "instance_id": "django__django-16032",
  "query": "__in doesn't clear selected fields on the RHS when QuerySet.alias() is used after annotate().\nDescription\n\t\nHere is a test case to reproduce the bug, you can add this in tests/annotations/tests.py\n\tdef test_annotation_and_alias_filter_in_subquery(self):\n\t\tlong_books_qs = (\n\t\t\tBook.objects.filter(\n\t\t\t\tpages__gt=400,\n\t\t\t)\n\t\t\t.annotate(book_annotate=Value(1))\n\t\t\t.alias(book_alias=Value(1))\n\t\t)\n\t\tpublisher_books_qs = (\n\t\t\tPublisher.objects.filter(\n\t\t\t\tbook__in=long_books_qs\n\t\t\t)\n\t\t\t.values(\"name\")\n\t\t)\n\t\tself.assertCountEqual(\n\t\t\tpublisher_books_qs,\n\t\t\t[\n\t\t\t\t{'name': 'Apress'},\n\t\t\t\t{'name': 'Sams'},\n\t\t\t\t{'name': 'Prentice Hall'},\n\t\t\t\t{'name': 'Morgan Kaufmann'}\n\t\t\t]\n\t\t)\nYou should get this error:\ndjango.db.utils.OperationalError: sub-select returns 10 columns - expected 1\n",
  "ground_truth": {
    "files": [
      "django/db/models/fields/related_lookups.py",
      "django/db/models/sql/query.py"
    ],
    "locations": [
      "django/db/models/fields/related_lookups.py::RelatedIn",
      "django/db/models/fields/related_lookups.py::RelatedIn.get_prep_lookup",
      "django/db/models/fields/related_lookups.py::RelatedIn.as_sql",
      "django/db/models/sql/query.py::Query",
      "django/db/models/sql/query.py::Query.output_field",
      "django/db/models/sql/query.py::Query.has_select_fields",
      "django/db/models/sql/query.py::Query.base_table",
      "django/db/models/sql/query.py::Query.set_values"
    ]
  },
  "predictions": [
    "tests/annotations/tests.py::NonAggregateAnnotationTestCase.test_annotation_filter_with_subquery",
    "tests/aggregation/tests.py::AggregateTestCase.test_filtering",
    "tests/aggregation_regress/tests.py::AggregationTests.test_aggregate_fexpr",
    "tests/aggregation/tests.py::AggregateTestCase.test_aggregation_exists_annotation",
    "tests/annotations/tests.py::NonAggregateAnnotationTestCase.test_annotation_in_f_grouped_by_annotation",
    "tests/aggregation_regress/tests.py::AggregationTests.test_annotation_disjunction",
    "tests/aggregation/tests.py::AggregateTestCase.test_aggregation_default_using_date_from_database",
    "tests/aggregation/tests.py::AggregateTestCase.test_aggregation_default_compound_expression",
    "tests/aggregation/tests.py::AggregateTestCase.test_aggregation_default_using_date_from_python",
    "tests/aggregation/tests.py::AggregateTestCase.test_group_by_exists_annotation"
  ],
  "metadata": {
    "repo": "django/django",
    "commit": "0c3981eb5094419fe200eb46c71b5376a2266166",
    "total_functions_indexed": 26155,
    "retrieval_time_seconds": 1.2951300144195557
  },
  "raw_output": "[{\"doc_id\": \"tests/annotations/tests.py::NonAggregateAnnotationTestCase.test_annotation_filter_with_subquery\", \"score\": 165.1097347689362}, {\"doc_id\": \"tests/aggregation/tests.py::AggregateTestCase.test_filtering\", \"score\": 103.67149589123466}, {\"doc_id\": \"tests/aggregation_regress/tests.py::AggregationTests.test_aggregate_fexpr\", \"score\": 100.21194629653878}, {\"doc_id\": \"tests/aggregation/tests.py::AggregateTestCase.test_aggregation_exists_annotation\", \"score\": 96.83370659192349}, {\"doc_id\": \"tests/annotations/tests.py::NonAggregateAnnotationTestCase.test_annotation_in_f_grouped_by_annotation\", \"score\": 96.32007382188313}, {\"doc_id\": \"tests/aggregation_regress/tests.py::AggregationTests.test_annotation_disjunction\", \"score\": 83.43733267315477}, {\"doc_id\": \"tests/aggregation/tests.py::AggregateTestCase.test_aggregation_default_using_date_from_database\", \"score\": 82.46141256311915}, {\"doc_id\": \"tests/aggregation/tests.py::AggregateTestCase.test_aggregation_default_compound_expression\", \"score\": 80.9911362464454}, {\"doc_id\": \"tests/aggregation/tests.py::AggregateTestCase.test_aggregation_default_using_date_from_python\", \"score\": 80.60875147508334}, {\"doc_id\": \"tests/aggregation/tests.py::AggregateTestCase.test_group_by_exists_annotation\", \"score\": 78.3196884241143}]"
}